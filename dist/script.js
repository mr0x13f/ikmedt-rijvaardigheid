!function(t){var e={};function i(n){if(e[n])return e[n].exports;var o=e[n]={i:n,l:!1,exports:{}};return t[n].call(o.exports,o,o.exports,i),o.l=!0,o.exports}i.m=t,i.c=e,i.d=function(t,e,n){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)i.d(n,o,function(e){return t[e]}.bind(null,o));return n},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=0)}([function(t,e,i){"use strict";var n;i.r(e),function(t){t[t.ACCELERATE=0]="ACCELERATE",t[t.BRAKE=1]="BRAKE",t[t.STEERING=2]="STEERING",t[t.CLUTCH=3]="CLUTCH",t[t.HANDBRAKE=4]="HANDBRAKE",t[t.HEADLIGHTS=5]="HEADLIGHTS",t[t.NEUTRAL=6]="NEUTRAL",t[t.DOGBOX_UP=7]="DOGBOX_UP",t[t.DOGBOX_DOWN=8]="DOGBOX_DOWN",t[t.PAUSE=9]="PAUSE",t[t.CONFIRM=10]="CONFIRM"}(n||(n={}));var o,r,s,a,u,h=function(){function t(t){this.inverted=!1,this.minValue=0,this.index=t}return t.prototype.getValue=function(t){return t.buttons[this.index].value*(this.inverted?-1:1)},t.prototype.isPressed=function(t){return this.getValue(t)>this.minValue},t.prototype.invert=function(){this.inverted=!0},t.prototype.setMinValue=function(t){this.minValue=t},t}(),c=function(){function t(t){this.minDeadzone=0,this.maxDeadzone=1,this.isNormalized=!1,this.index=t}return t.prototype.getValue=function(t){var e=t.axes[this.index].valueOf(),i=e>0,n=Math.abs(e);return n<this.minDeadzone?n=this.minDeadzone:n>this.maxDeadzone&&(n=this.maxDeadzone),n=(n-this.minDeadzone)/(this.maxDeadzone-this.minDeadzone),n*=i?1:-1,this.isNormalized&&(n=n/2+.5),n},t.prototype.isPressed=function(t){return!1},t.prototype.deadzone=function(t,e){return this.minDeadzone=t,this.maxDeadzone=e,this},t.prototype.normalize=function(){return this.isNormalized=!0,this},t}(),d=function(){function t(t){this.triggerPoint=0,this.inverted=!1,this.input=t}return t.prototype.getValue=function(t){return this.input.getValue(t)*(this.inverted?-1:1)},t.prototype.isPressed=function(t){return this.getValue(t)>=this.triggerPoint},t.prototype.invert=function(){return this.inverted=!0,this},t.prototype.setTriggerPoint=function(t){return this.triggerPoint=t,this},t}(),l=function(){function t(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this.inputs=t}return t.prototype.getValue=function(t){return this.isPressed(t)?1:0},t.prototype.isPressed=function(t){for(var e=0,i=this.inputs;e<i.length;e++){if(i[e].isPressed(t))return!0}return!1},t}(),p=function(){var t;this.NAME="STANDARD GAMEPAD",this.MAPPING=((t={})[n.STEERING]=new c(0).deadzone(.01,1),t[n.ACCELERATE]=new h(7),t[n.BRAKE]=new h(6),t[n.CLUTCH]=new l(new h(4),new h(5)),t[n.HANDBRAKE]=new h(0),t[n.HEADLIGHTS]=new h(2),t[n.NEUTRAL]=new h(11),t[n.DOGBOX_UP]=new d(new c(3)).setTriggerPoint(.5).invert(),t[n.DOGBOX_DOWN]=new d(new c(3)).setTriggerPoint(.5),t[n.PAUSE]=new h(9),t[n.CONFIRM]=new h(0),t)},f=function(){var t;this.NAME="MAYFLASH GameCube Controller Adapter",this.MAPPING=((t={})[n.STEERING]=new c(0).deadzone(.05,.75),t[n.ACCELERATE]=new c(4).deadzone(0,.6).normalize(),t[n.BRAKE]=new c(3).deadzone(0,.6).normalize(),t[n.CLUTCH]=new h(7),t[n.HANDBRAKE]=new h(1),t[n.HEADLIGHTS]=new h(12),t[n.NEUTRAL]=new h(2),t[n.DOGBOX_UP]=new d(new c(2)).setTriggerPoint(.3).invert(),t[n.DOGBOX_DOWN]=new d(new c(2)).setTriggerPoint(.3),t[n.PAUSE]=new h(9),t[n.CONFIRM]=new h(1),t)};!function(t){var e,i,o=[],r={},s={};function a(t){o.push(t)}function u(t){var n=t;console.log(n.gamepad.id+" has connected.");for(var r=null,s=0,a=o;s<a.length;s++){var u=a[s];-1!=n.gamepad.id.search(u.NAME)&&(r=u)}r?(e=n.gamepad,i=r,console.log("Controller mapping applied: "+r.NAME)):alert("No controller mapping found for "+n.gamepad.id)}function h(t){var i=t;i.gamepad==e&&(e=null,console.log(i.gamepad.id+" has disconnected."))}t.init=function(){a(new p),a(new f),window.addEventListener("gamepadconnected",u),window.addEventListener("gamepaddisconnected",h)},t.handleInputs=function(){if(s=r,r={},e&&(e=navigator.getGamepads()[e.index]))for(var t in n)isNaN(Number(t))||i.MAPPING[t].isPressed(e)&&(r[t]=!0)},t.isDown=function(t){return!!e&&1==r[t]},t.isPressed=function(t){return!!e&&(1==r[t]&&1!=s[t])},t.getAxes=function(t){return e?i.MAPPING[t].getValue(e):0}}(o||(o={})),s=r||(r={}),a=[],u={},s.init=function(){var t;a=[],u={},t=0,window.requestAnimationFrame((function e(i){s.dt=(i-t)/1e3,t=i,o.handleInputs(),function(){for(var t=0,e=a;t<e.length;t++)e[t].doUpdate()}(),window.requestAnimationFrame(e)}))},s.addEntity=function(t){a.push(t),t.id&&(u[t.id]=t)},s.getEntityById=function(t){return u[t]};var y,E,g,R,m=function(){function t(){}return t.getSource=function(){return""},t.load=function(t){},t.show=function(t){var e=this,i=document.getElementById("js--scene");i.setAttribute("template","src",this.getSource()),r.init(),i.addEventListener("DOMNodeInserted",(function(i){window.requestAnimationFrame((function(){e.load(t)}))}))},t}(),A=function(){function t(t,e,i){this.x=0,this.y=0,this.z=0,this.x=t||0,this.y=e||t||0,this.z=i||t||0}return t.prototype.toString=function(){return"("+this.x+","+this.y+","+this.z+")"},t.prototype.magnitude=function(){return Math.sqrt(this.magnitude2())},t.prototype.magnitude2=function(){return this.x*this.x+this.y*this.y+this.z*this.z},t.prototype.normalize=function(){return this.divNum(this.magnitude())},t.prototype.add=function(e){return new t(this.x+e.x,this.y+e.y,this.z+e.z)},t.prototype.sub=function(e){return new t(this.x-e.x,this.y-e.y,this.z-e.z)},t.prototype.mul=function(e){return new t(this.x*e.x,this.y*e.y,this.z*e.z)},t.prototype.div=function(e){return new t(this.x/e.x,this.y/e.y,this.z/e.z)},t.prototype.mulNum=function(e){return new t(this.x*e,this.y*e,this.z*e)},t.prototype.divNum=function(e){return new t(this.x/e,this.y/e,this.z/e)},t.prototype.numDiv=function(e){return new t(e/this.x,e/this.y,e/this.z)},t}(),D=function(){function t(t){this.element=null,this.object3D=null,this.id=null,t?(this.id=t,this.element=document.getElementById(t),this.object3D=this.element.object3D,this.position=new A(this.object3D.position.x,this.object3D.position.y,this.object3D.position.z),this.rotation=new A(this.object3D.rotation.x,this.object3D.rotation.y,this.object3D.rotation.z),this.velocity=new A(0,0,0)):(this.position=new A(0,0,0),this.rotation=new A(0,0,0),this.velocity=new A(0,0,0)),r.addEntity(this)}return t.prototype.update=function(){},t.prototype.doUpdate=function(){this.update(),this.velocity.magnitude()<.001&&(this.velocity=new A(0,0,0)),this.position=this.position.add(this.velocity.mulNum(r.dt)),this.object3D.position.x=this.position.x,this.object3D.position.y=this.position.y,this.object3D.position.z=this.position.z,this.object3D.rotation.x=this.rotation.x,this.object3D.rotation.y=this.rotation.y,this.object3D.rotation.z=this.rotation.z},t}();!function(t){t.REVERSE="R",t.NEUTRAL="N",t.FIRST="1",t.SECOND="2",t.THIRD="3",t.FOURTH="4",t.FIFTH="5"}(R||(R={}));var w,v,O=((y={})[R.REVERSE]=R.NEUTRAL,y[R.NEUTRAL]=R.FIRST,y[R.FIRST]=R.SECOND,y[R.SECOND]=R.THIRD,y[R.THIRD]=R.FOURTH,y[R.FOURTH]=R.FIFTH,y[R.FIFTH]=null,y),T=((E={})[R.REVERSE]=null,E[R.NEUTRAL]=R.REVERSE,E[R.FIRST]=R.NEUTRAL,E[R.SECOND]=R.FIRST,E[R.THIRD]=R.SECOND,E[R.FOURTH]=R.THIRD,E[R.FIFTH]=R.FOURTH,E);(g={})[R.REVERSE]=new A(.5,-.5,0),g[R.NEUTRAL]=new A(0,0,0),g[R.FIRST]=new A(-.5,.5,0),g[R.SECOND]=new A(-.5,-.5,0),g[R.THIRD]=new A(0,.5,0),g[R.FOURTH]=new A(0,-.5,0),g[R.FIFTH]=new A(-.5,.5,0);!function(t){t.HORSEPOWER_CONSTANT=5252,t.GRAVITY=9.81}(w||(w={})),function(t){t[t.REAR_WHEEL_DRIVE=0]="REAR_WHEEL_DRIVE",t[t.FRONT_WHEEL_DRIVE=1]="FRONT_WHEEL_DRIVE",t[t.FOUR_WHEEL_DRIVE=2]="FOUR_WHEEL_DRIVE"}(v||(v={}));var I,N,H=(I=function(t,e){return(I=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)},function(t,e){function i(){this.constructor=t}I(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}),_=function(t){function e(e,i){var n,o=t.call(this,e)||this;return o.isHeadlightsOn=!1,o.direction=new A,o.currentGear=R.FIRST,o.acceleration=0,o.rpm=1e3,o.rearAngularVelocity=0,o.frontAngularVelocity=0,o.gearIndicatorMap=((n={})[R.REVERSE]="-43 87 35",n[R.NEUTRAL]="-38 90 35",n[R.FIRST]="-33 93 35",n[R.SECOND]="-33 87 35",n[R.THIRD]="-38 93 35",n[R.FOURTH]="-38 87 35",n[R.FIFTH]="-43 93 35",n),o.carModel=i,o.headlightLeft=document.getElementById("js--car-headlight-left"),o.headlightRight=document.getElementById("js--car-headlight-right"),o.steeringWheel=document.getElementById("js--car-steering-wheel"),o.debugText=document.getElementById("js--debug-text"),o.gearIndicator=document.getElementById("js--gear-indicator"),o.velocity=new A(0,0,0),o.direction=new A(0,0,-1),o.setHeadlights(!1),o}return H(e,t),e.prototype.update=function(){o.isPressed(n.HEADLIGHTS)&&this.toggleHeadlights(),this.shift(),this.physics(),this.turnSteeringWheel()},e.prototype.toggleHeadlights=function(){this.isHeadlightsOn=!this.isHeadlightsOn,this.updateHeadlights()},e.prototype.setHeadlights=function(t){this.isHeadlightsOn=t,this.updateHeadlights()},e.prototype.updateHeadlights=function(){this.headlightLeft.setAttribute("visible",""+this.isHeadlightsOn),this.headlightRight.setAttribute("visible",""+this.isHeadlightsOn)},e.prototype.shift=function(){o.isDown(n.CLUTCH)&&(o.isPressed(n.DOGBOX_UP)&&T[this.currentGear]&&(this.currentGear=T[this.currentGear],this.updateGear()),o.isPressed(n.DOGBOX_DOWN)&&O[this.currentGear]&&(this.currentGear=O[this.currentGear],this.updateGear()))},e.prototype.updateGear=function(){console.log(this.currentGear),this.updateGearUI()},e.prototype.updateGearUI=function(){var t=this.gearIndicatorMap[this.currentGear];this.gearIndicator.setAttribute("position",t)},e.prototype.turnSteeringWheel=function(){var t=o.getAxes(n.STEERING);this.steeringWheel.object3D.rotation.z=90*t/180*Math.PI},e.prototype.physics=function(){this.velocity.magnitude2()>0&&(this.direction=this.velocity.normalize());var t,e=this.carModel.torqueCurve(this.rpm)*o.getAxes(n.ACCELERATE)*this.carModel.gearRatios[this.currentGear]*this.carModel.differentialRatio*this.carModel.transmissionEfficiency/this.carModel.wheelRadius,i=this.velocity.mulNum(-this.carModel.dragConstant*this.velocity.magnitude()),s=this.velocity.mulNum(-this.carModel.rollingResistanceConstant),a=this.carModel.mass*w.GRAVITY,u=this.carModel.centerOfGravity.y+this.carModel.frontWheelPosition.y,h=this.carModel.centerOfGravity.y+this.carModel.rearWheelPosition.y,c=u+h,d=h/c,l=u/c*a-this.carModel.centerOfGravity.y/c*this.carModel.mass*this.acceleration,p=d*a+this.carModel.centerOfGravity.y/c*this.carModel.mass*this.acceleration;this.carModel.tyreFrictionCoefficient,this.carModel.tyreFrictionCoefficient;(this.carModel.layout==v.FRONT_WHEEL_DRIVE||this.carModel.layout==v.FOUR_WHEEL_DRIVE||(0,this.velocity.magnitude()/(2*Math.PI*this.carModel.wheelRadius)),this.carModel.layout==v.REAR_WHEEL_DRIVE||this.carModel.layout==v.FOUR_WHEEL_DRIVE||(0,this.velocity.magnitude()/(2*Math.PI*this.carModel.wheelRadius)),o.getAxes(n.BRAKE)>0)?t=this.direction.mulNum(this.carModel.brakingConstant).add(i.add(s)):t=this.direction.mulNum(e).add(i.add(s));var f=t.divNum(this.carModel.mass);this.velocity=this.velocity.add(f.mulNum(r.dt)),this.acceleration=f.magnitude(),this.debugText.setAttribute("value",this.velocity.magnitude()+"\nkm/h")},e}(D),S=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}();!function(t){t[t.DAY=0]="DAY",t[t.NIGHT=1]="NIGHT"}(N||(N={}));var P=function(t){function e(i){var n=t.call(this,i)||this;return n.currentSky=N.DAY,e.skies[N.DAY]=document.getElementById("js--sky-day"),e.skies[N.NIGHT]=document.getElementById("js--sky-night"),n.currentSky=N.DAY,n.setSky(n.currentSky),n}return S(e,t),e.prototype.setSky=function(t){this.clearSky(),this.currentSky=t,e.skies[t].setAttribute("visible","true")},e.prototype.clearSky=function(){e.skies[N.DAY].setAttribute("visible","false"),e.skies[N.NIGHT].setAttribute("visible","false")},e.skies={},e}(D),b=function(){var t;this.frameModel="",this.steeringWheelModel="",this.handBrakeModel="",this.headlightPosition=new A,this.cameraPosition=new A,this.steeringWheelPosition=new A,this.dragConstant=.4257,this.brakingConstant=-1e4,this.tyreFrictionCoefficient=1.5,this.wheelRadius=.3265,this.frontWheelPosition=new A,this.rearWheelPosition=new A,this.mass=1560,this.centerOfGravity=new A,this.layout=v.FOUR_WHEEL_DRIVE,this.rollingResistanceConstant=12.8,this.transmissionEfficiency=.7,this.differentialRatio=3.42,this.gearRatios=((t={})[R.REVERSE]=2.9,t[R.NEUTRAL]=0,t[R.FIRST]=2.66,t[R.SECOND]=1.78,t[R.THIRD]=1.3,t[R.FOURTH]=1,t[R.FIFTH]=.74,t),this.idleRpm=1e3,this.stallRpm=1e3,this.redlineRpm=7e3,this.torqueCurve=function(t){return-3792735043e-15*t*t+.03803418803*t+254.6474359}},M=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),G=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return M(e,t),e.getSource=function(){return"scenes/simulation.html"},e.load=function(t){new _("js--car",new b).setHeadlights(!1),new P("js--sky").setSky(N.DAY)},e}(m);window.onload=function(){o.init(),G.show()}}]);